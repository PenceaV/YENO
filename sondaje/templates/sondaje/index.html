{% extends 'sondaje/base.html' %}

{% block title %}YENO{% endblock %}

{% block content %}
<div class="space-y-6" style="padding-left: 20px; padding-right: 20px; padding-top: 20px; padding-bottom: 20px;">
        
        <div class="flex justify-end items-center mb-6">
            <div class="flex items-center gap-3">
                {% if user.is_authenticated %}
                
                <div class="relative">
                    <button type="button" id="filterButton" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span class="text-sm font-medium text-gray-700">Filtre</span>
                        {% if filtre_active %}
                        <span class="bg-primary-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">{{ filtre_active|length }}</span>
                        {% endif %}
                    </button>
                    
                    
                    <div id="filterDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                        <form method="get" action="{% url 'sondaje:index' %}" id="filterForm" class="p-3">
                            <div class="mb-3">
                                <h3 class="text-sm font-semibold text-gray-900 mb-2">Tip Sondaj</h3>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    <label class="flex items-center py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                                        <input type="checkbox" name="tip[]" value="public" 
                                               {% if 'public' in filtre_active %}checked{% endif %}
                                               class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 filter-checkbox">
                                        <span class="ml-4 text-sm text-gray-700">Publice</span>
                                    </label>
                                    {% for echipa in echipele_user %}
                                    <label class="flex items-center py-2 cursor-pointer hover:bg-gray-50 rounded px-2">
                                        <input type="checkbox" name="tip[]" value="{{ echipa.id }}" 
                                               {% if echipa.id|stringformat:"s" in filtre_active %}checked{% endif %}
                                               class="w-4 h-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 filter-checkbox">
                                        <span class="ml-4 text-sm text-gray-700">{{ echipa.nume }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            {% if filtre_active %}
                            <div class="pt-2 border-t border-gray-200">
                                <a href="{% url 'sondaje:index' %}" 
                                   class="block w-full px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium text-center">
                                    Șterge filtre
                                </a>
                            </div>
                            {% endif %}
                        </form>
                    </div>
                </div>
                
                <a href="{% url 'sondaje:creeaza_sondaj' %}" 
                   class="btn-primary">
                    Creează Sondaj
                </a>
                {% endif %}
            </div>
        </div>

    {% if lista_intrebari %}
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-stretch">
            {% for intrebare in lista_intrebari %}
            <div class="bg-white rounded-3xl shadow-bubbly hover:shadow-bubbly-lg transition-all duration-300 overflow-hidden border border-purple-100 group flex flex-col h-full" 
                 {% if intrebare.data_expirare %}data-expires="{{ intrebare.data_expirare|date:'c' }}"{% endif %}>
                <div class="p-6 flex flex-col flex-1 h-full">
                    <div class="flex-1">
                        <h3 class="text-xl font-semibold text-gray-900 mb-2">
                            {{ intrebare.text_intrebare }}
                        </h3>
                        <p class="text-sm text-gray-500 flex items-center font-medium mb-3">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            {{ intrebare.data_publicare|date:"d M Y, H:i" }}
                        </p>
                        {% if intrebare.echipa %}
                            <p class="text-sm text-primary-600 flex items-center font-medium mb-3">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Echipă: {{ intrebare.echipa.nume }}
                            </p>
                        {% endif %}
                        {% if intrebare.data_expirare %}
                            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-3">
                                <div class="flex items-center gap-3">
                                    <svg class="w-4 h-4 text-orange-600 flex-shrink-0 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="flex-1">
                                        <span class="text-xs font-semibold text-orange-700 block mb-1">Timp rămas:</span>
                                        <span class="countdown text-lg font-bold text-orange-600" data-expires="{{ intrebare.data_expirare|date:'c' }}">--:--</span>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-auto pt-4">
                        <a href="{% url 'sondaje:detalii' intrebare.id %}" 
                           class="btn-primary w-full sondaj-link">
                            Participă la sondaj
                            <svg class="w-5 h-5 ml-2 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        
        <div class="bg-white rounded-3xl shadow-bubbly p-12 text-center border border-purple-100">
            <div class="max-w-md mx-auto">
                <h3 class="text-2xl font-bold text-gray-900 mb-3">Niciun sondaj disponibil</h3>
                <p class="text-gray-600 text-lg font-medium">Momentan nu există sondaje disponibile. Revino mai târziu!</p>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Toggle pentru dropdown-ul de filtre
document.addEventListener('DOMContentLoaded', function() {
    const filterButton = document.getElementById('filterButton');
    const filterDropdown = document.getElementById('filterDropdown');
    
    if (filterButton && filterDropdown) {
        // Toggle dropdown la click pe buton
        filterButton.addEventListener('click', function(e) {
            e.stopPropagation();
            filterDropdown.classList.toggle('hidden');
        });
        
        // Închide dropdown când se face click în afara lui
        document.addEventListener('click', function(e) {
            if (!filterButton.contains(e.target) && !filterDropdown.contains(e.target)) {
                filterDropdown.classList.add('hidden');
            }
        });
        
        // Previne închiderea dropdown-ului când se face click în interior
        filterDropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Auto-submit formularul când se schimbă un checkbox
    const filterForm = document.getElementById('filterForm');
    const checkboxes = document.querySelectorAll('.filter-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            filterForm.submit();
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const countdownElements = document.querySelectorAll('.countdown');
    
    function updateCountdowns() {
        countdownElements.forEach(function(element) {
            const expiresStr = element.getAttribute('data-expires');
            if (!expiresStr) return;
            
            const expires = new Date(expiresStr);
            const now = new Date();
            const diff = expires - now;
            
            if (diff <= 0) {
                element.textContent = '00:00';
                element.classList.add('text-red-600');
                element.classList.remove('text-orange-600');
                
                // Dezactivează link-ul către sondaj
                const card = element.closest('.bg-white');
                if (card) {
                    const link = card.querySelector('.sondaj-link');
                    if (link) {
                        link.style.pointerEvents = 'none';
                        link.style.opacity = '0.5';
                        link.textContent = 'Sondaj expirat';
                    }
                }
                return;
            }
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            const formatted = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
            element.textContent = formatted;
            
            // Schimbă culoarea când rămân puține minute
            if (minutes < 1) {
                element.classList.remove('text-orange-600');
                element.classList.add('text-red-600', 'animate-pulse');
            }
        });
    }
    
    // Actualizează la fiecare secundă
    updateCountdowns();
    setInterval(updateCountdowns, 1000);
});
</script>
{% endblock %}
